<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Administrador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="/static/corona.png" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Fondo y color de texto del body */
        body {
            background: linear-gradient(135deg, #f3f4f6, #dbe2e8);
            color: #333;
            font-family: 'Arial', sans-serif;
            padding-bottom: 50px;
        }

        /* Estilo para los títulos */
        h2, h3 {
            color: #ffffff;
            font-weight: bold;
        }

        /* Estilo de los botones */
        .btn {
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        /* Barra de navegación */
        .navbar {
            background-color: #004d6b;
            padding: 8px 0;
        }

        .navbar-brand, .navbar-nav .nav-item .btn {
            color: #fff !important;
        }

        .navbar-nav .nav-item .btn:hover {
            background-color: #ff5722;
        }

        /* Efectos de sombras para las tarjetas */
        .card-header {
            background-color: #4c4c4c;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
        }

        .card:hover {
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .alert {
            border-radius: 12px;
        }

        /* Estilo para tablas */
        table {
            border-radius: 10px;
            overflow: hidden;
            width: 100%; 
            table-layout: auto; /* Asegura que el ancho de las celdas sea flexible */
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        th, td {
            padding: 12px; /* Aumenté el padding para mejorar el espaciado */
            text-align: center;
            vertical-align: middle;
            min-width: 160px; /* Aumenté el tamaño mínimo para las celdas */
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        /* Estilo para los inputs */
        input.form-control {
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        input.form-control:focus {
            border-color: #006a82;
            box-shadow: 0 0 10px rgba(0, 106, 130, 0.3);
        }

        /* Espaciado general */
        .container {
            margin-top: 5px;
        }

        .navbar .navbar-brand {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Panel Administrador</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button class="btn btn-danger" onclick="cerrarSesion()">Cerrar sesión</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenedor para mensajes flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div id="flash-messages" data-messages='{{ messages | tojson }}'></div>
    {% endif %}
    {% endwith %}

    <!-- Contenido principal -->
    <div class="container">
        <h2 class="text-center text-primary mt-4"><i class="fas fa-crown"></i> Bienvenido Sysadmin</h2>
        {% for modulo, data in datos_generales.items() %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>Base: {{ modulo }}</h3>
                    <div class="form-check form-switch"> 
                        <input class="form-check-input toggle-edicion" type="checkbox" id="switch-{{ modulo }}">
                        <label class="form-check-label" for="switch-{{ modulo }}">Editar</label>
                    </div>
                </div>

                {% if data.error %}
                    <div class="alert alert-danger m-4" role="alert">
                        Error: {{ data.error }}
                    </div>
                {% else %}
                    <form method="POST" action="{{ url_for('admin.guardar_datos', modulo=modulo) }}">
                        <div class="table-responsive" style="max-width: 100%;">
                            <table class="table table-bordered table-striped">
                                <thead class="table-light">
                                    <tr>
                                        {% for header in data.headers %}
                                            <th>{{ header }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set campos = ['DatosGeneralesKey', 'RFCTaxId', 'RazonSocial', 'Calle', 'NumExterior', 'NumInterior', 'Colonia', 'CodigoPostal', 'Municipio', 'Estado', 'Pais', 'NumeroPrograma', 'Certificacion', 'Licencia'] %}
                                    {% for row in data.rows %}
                                        <tr>
                                            {% for i in range(1, campos|length) %}
                                                <td>
                                                    <input 
                                                        type="text" 
                                                        name="{{ campos[i] }}" 
                                                        class="form-control editable editable-{{ modulo | replace(' ', '_') }}" 
                                                        value="{{ '' if row[i] is none else row[i] }}"
                                                        disabled
                                                    >
                                                </td>
                                            {% endfor %}
                                            <input type="hidden" name="id" value="{{ row[0] }}">
                                            <input type="hidden" name="rfc_original" value="{{ row[1] }}">
                                            <input type="hidden" name="rfc" value="{{ row[1] }}">
                                            <input type="hidden" name="Licencia" value="{{ row[13] }}">
                                            <input type="hidden" name="RFCTaxId" value="{{ row[1] }}">
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Botón de validar -->
                        <button type="submit" class="btn btn-primary" 
                        style="margin: 5px 0 10px 20px;"
                         formaction="{{ url_for('admin.validar_licencia') }}" formmethod="POST">
                            Validar licencia
                        </button>

                        <!-- Botones de edición solo si está habilitado -->
                        <div class="botones-edicion botones-edicion-{{ modulo | replace(' ', '_') }}" style="display: none;">
                            <button type="submit" class="btn btn-success" style="margin: 5px 0 10px 20px;" >Guardar cambios</button>
                            <a href="{{ url_for('admin.access_view') }}" class="btn btn-danger" style="margin: 5px 0 10px 20px;" >Cancelar</a>
                        </div>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <script>
        function cerrarSesion() {
            window.location.href = "{{ url_for('login.logout') }}";
        }

        document.addEventListener('DOMContentLoaded', () => {
            const flashContainer = document.getElementById('flash-messages');
            if (!flashContainer) return;

            let flashes;
            try {
                flashes = JSON.parse(flashContainer.getAttribute('data-messages'));
            } catch (e) {
                console.error('Error parsing flash messages JSON:', e);
                return;
            }

            flashes.forEach(flash => {
                const category = flash[0];
                const message = flash[1];

                if (category === 'success_license') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Operación exitosa',
                        html: message.tipo === 'guardar' ? `
                            <p><strong>RFC:</strong> ${message.rfc}</p>
                            <p><strong>Licencia válida hasta:</strong> ${message.vence}</p>
                        ` : `
                            <p><strong>RFC:</strong> ${message.rfc}</p>
                            <p><strong>Licencia válida hasta:</strong> ${message.vence}</p>
                        `,
                        confirmButtonText: 'Aceptar',
                        timer: 3000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                } else if (category === 'danger') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: message,
                        timer: 3000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    });
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.toggle-edicion').forEach(toggle => {
                toggle.addEventListener('change', function () {
                    const modulo = this.id.replace('switch-', '').replace(/\s/g, '_');
                    const inputs = document.querySelectorAll('.editable-' + modulo);
                    const botonesEdicion = document.querySelector('.botones-edicion-' + modulo);

                    if (this.checked) {
                        inputs.forEach(input => input.removeAttribute('disabled'));
                        if (botonesEdicion) botonesEdicion.style.display = 'inline-block';
                    } else {
                        inputs.forEach(input => input.setAttribute('disabled', 'disabled'));
                        if (botonesEdicion) botonesEdicion.style.display = 'none';
                    }
                });
            });
        });
    </script>

    <script src="/static/js/inactividad.js"></script>
</body>
</html>
