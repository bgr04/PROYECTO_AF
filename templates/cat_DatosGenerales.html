<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" href="/static/img/icon_datosgenerales.png" type="image/x-icon">
    <title>Catálogo Datos Generales</title>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="/static/style_dashboard.css">
    <link rel="stylesheet" href="/static/style_datosgrales.css">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <!-- Librerías JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- Otras librerías -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Scripts locales -->
    <script src="/static/js/inactividad.js"></script>

    <script>
    window.history.forward();
    function noBack() { window.history.forward(); }
    </script>
</head>
<body onload="noBack();" onpageshow="if (event.persisted) noBack();">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid" id="navbar2">

      <!-- Marca / logo + eslogan -->
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard.dashboard') }}">
        <img src="/static/img/chatimagen3.png"
             alt="Logo"
             id="icono"
             class="me-2" style="width: 150px; height: 48px; object-fit: contain;">
        <span id="eslogan" class="fw-semibold">Sistema de Control AF</span>
      </a>

      <!-- Botón hamburguesa -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarMain" aria-controls="navbarMain"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Contenido colapsable -->
      <div class="collapse navbar-collapse" id="navbarMain">
        <!-- Navegación izquierda -->
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">

          <li class="nav-item">
            <a class="nav-link active" aria-current="page"
               href="{{ url_for('dashboard.dashboard') }}">
              <i class="fa fa-home me-1"></i> Inicio
            </a>
          </li>

          <!-- Dropdown de módulos -->
          <li class="nav-item dropdown">
            <a class="nav-link d-flex align-items-center gap-1" href="#" id="modDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-solid fa-layer-group me-1"></i> Catálogos
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="modDropdown">
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_datos_generales') }}">Datos Generales</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_usuarios') }}">Usuarios</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_proveedores') }}">Proveedores</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_clientes') }}">Clientes</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_categoria') }}">Categoría</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_departamento') }}">Departamento</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_tipoEquipos') }}">Tipo de Equipo</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_estado') }}">Estado</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_archivos') }}">Archivos</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.cat_activoFijo') }}">Activo Fijo</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link d-flex align-items-center gap-1" href="#" id="modDropdown"
                role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-solid fa-cubes me-1"></i> Control Activo Fijo
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="modDropdown">
              <li><a class="dropdown-item" href="{{ url_for('rutas.controlAF_E') }}">Entradas</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.controlAF_S') }}">Salidas</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('rutas.expedienteD') }}"><i class="fa-solid fa-file-lines me-1"></i> Expediente Digital</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link d-flex align-items-center gap-1" href="#" id="modDropdown"
               role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fa-solid fa-chart-column me-1"></i> Reportes
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="modDropdown">
              <li><a class="dropdown-item" href="{{ url_for('rutas.reporteG') }}">General</a></li>
              <li><a class="dropdown-item" href="{{ url_for('rutas.reporteED') }}">Expediente Digital</a></li>
            </ul>
          </li>
        </ul>

        <!-- Dropdown de usuario (derecha) -->
        <div class="dropdown">
          <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center"
                  type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <!-- Avatar SVG / Img -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewBox="10 10 77 77"
                 class="me-2" style="width: 32px; height: 32px;">
              <!-- Puedes sustituir por <img> si prefieres -->
              <circle cx="48" cy="48" r="36" fill="#FF0505"></circle>
              <circle cx="48" cy="40" r="12" fill="#fff"></circle>
              <path d="M24,72c6-12,42-12,48,0" fill="#fff"></path>
            </svg>
            <span id="name"><strong>{{ usuario }}
            </strong></span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li><a class="dropdown-item" href="#"><i class="fa fa-user me-2"></i>Información</a></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="{{ url_for('login.logout') }}">
                <i class="fa-solid fa-door-open me-1"></i> Salir
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>
  
  <div class="container mt-4 mb-5">
    {% if datos %}
    <form id="form-datos-generales" method="POST">
      <input type="hidden" name="DatosGeneralesKey" value="{{ datos.DatosGeneralesKey }}">
      <input type="hidden" name="RFCTaxId" value="{{ datos.RFCTaxId }}">
      <input type="hidden" name="RazonSocial" value="{{ datos.RazonSocial }}">
      <input type="hidden" name="Licencia" value="{{ datos.Licencia }}">

        <div class="card">
            <div class="card-header d-flex justify-content-between">
              <span>{{datos.RazonSocial}} ({{ datos.RFCTaxId }})</span>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="editarSwitch">
                <label class="form-check-label" for="editarSwitch">Editar</label>
              </div> 
            </div>
            
            <div class="card-body">
              <div class="section-header mb-4">
                <h5 class="section-title">
                  <i class="fa-solid fa-building me-2"></i>
                </h5>
                <hr class="section-divider mb-0">
              </div>

                <div class="row mb-5">
                    <div class="col-md-6">
                        <label class="form-label">Número Programa</label>
                        <input type="text" class="form-control editable" name="NumeroPrograma" value="{{ datos.NumeroPrograma or '' }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Certificación</label>
                        <input type="text" class="form-control editable" name="Certificacion" value="{{ datos.Certificacion or '' }}" disabled>
                    </div>
                </div>

                <div class="section-header mb-4">
                  <h5 class="section-title">
                    <i class="fa-solid fa-location-dot me-2"></i>
                  </h5>
                  <hr class="section-divider mb-0">
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Calle</label>
                        <input type="text" class="form-control editable" name="Calle" value="{{ datos.Calle or '' }}"disabled>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">N° Exterior</label>
                        <input type="text" class="form-control editable" name="NumExterior" value="{{ datos.NumExterior or '' }}" disabled>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">N° Interior</label>
                        <input type="text" class="form-control editable" name="NumInterior" value="{{ datos.NumInterior or '' }}" disabled>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Colonia</label>
                        <input type="text" class="form-control editable" name="Colonia" value="{{ datos.Colonia or '' }}" disabled>
                    </div>
                </div>

                <div class="row mb-3">                    
                    <div class="col-md-3">
                        <label class="form-label">Código Postal</label>
                        <input type="text" class="form-control editable" name="CodigoPostal" value="{{ datos.CodigoPostal or '' }}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Municipio</label>
                        <input type="text" class="form-control editable" name="Municipio" value="{{ datos.Municipio or '' }}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <input type="text" class="form-control editable" name="Estado" value="{{ datos.Estado or '' }}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">País</label>
                        <input type="text" class="form-control editable" name="Pais" value="{{ datos.Pais or '' }}" disabled>
                    </div>
                </div>

                <div class="botones-accion" id="botones-accion">
                  <button type="submit" class="btn btn-guardar me-2">
                    <i class="fa-solid fa-save me-1"></i> Guardar cambios
                  </button>
                  <button type="button" class="btn btn-cancelar" id="btn-cancelar">
                    <i class="fa-solid fa-xmark me-1"></i> Cancelar
                  </button>
                </div>
            </div>
        </div>
    </form>
    {% else %}
        <div class="alert alert-warning text-center">No se encontraron datos generales para mostrar.</div>
    {% endif %}
</div>
  
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editarSwitch = document.getElementById("editarSwitch");
  const inputs = document.querySelectorAll(".editable");
  const botones = document.getElementById("botones-accion");
  const btnCancelar = document.getElementById("btn-cancelar");
  const form = document.getElementById("form-datos-generales");

  const valoresOriginales = {};
  inputs.forEach(input => valoresOriginales[input.name] = input.value);

  // Detectar si hay cambios
  let hayCambios = false;
  inputs.forEach(input => {
    input.addEventListener("input", () => {
      hayCambios = Object.keys(valoresOriginales).some(
        name => valoresOriginales[name] !== document.querySelector(`[name="${name}"]`).value
      );
    });
  });

  // Activar edición
  editarSwitch.addEventListener("change", () => {
    const habilitar = editarSwitch.checked;
    inputs.forEach(input => input.disabled = !habilitar);
    botones.style.display = habilitar ? "block" : "none";

    if (!habilitar) {
      inputs.forEach(input => input.value = valoresOriginales[input.name]);
      hayCambios = false;
    }
  });

  // Cancelar cambios con confirmación
  btnCancelar.addEventListener("click", (e) => {
    if (hayCambios) {
      Swal.fire({
        title: "¿Deseas cancelar los cambios?",
        text: "Los datos modificados se perderán.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sí, cancelar",
        cancelButtonText: "No, continuar editando",
        reverseButtons: true,
        cancelButtonColor: "#028128", 
  confirmButtonColor: "#dd0202",
  background: "#fff0e2", 
      }).then((result) => {
        if (result.isConfirmed) {
          restaurarValores();
        }
      });
    } else {
      restaurarValores();
    }
  });

  function restaurarValores() {
    inputs.forEach(input => {
      input.value = valoresOriginales[input.name];
      input.disabled = true;
    });
    editarSwitch.checked = false;
    botones.style.display = "none";
    hayCambios = false;
  }

  // Guardar cambios vía AJAX
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    Swal.fire({
      title: "¿Deseas guardar los cambios?",
      icon: "question",      
      confirmButtonText: "Guardar",
      cancelButtonText: "Cancelar",
      showCancelButton: true,
      reverseButtons: false,
      confirmButtonColor: "#028128", 
  cancelButtonColor: "#dd0202"
    }).then((result) => {
      if (result.isConfirmed) {
        fetch("{{ url_for('rutas.actualizar_datos_generales') }}", {
          method: "POST",
          body: formData
        })
        .then(response => response.json().catch(() => ({ status: "error", message: "Respuesta inválida del servidor." })))
        .then(data => {
          if (data.status === "success") {
            Swal.fire({
              title: "¡Correcto!",
              text: data.message,
              icon: "success",
              timer: 2000,
              showConfirmButton: false
            });
            Object.keys(valoresOriginales).forEach(
              name => valoresOriginales[name] = document.querySelector(`[name="${name}"]`).value
            );
            restaurarValores();
          } else {
            Swal.fire("Error", data.message || "No se pudo actualizar.", "error");
          }
        })
        .catch(() => {
          Swal.fire("Error", "Ocurrió un problema al guardar los datos.", "error");
        });
      }
    });
  });
});
</script>


  <script>
    function noBack() {
      window.history.forward();
    }
    setTimeout("noBack()", 0);
    window.onunload = function () { null };
  </script>
</body>